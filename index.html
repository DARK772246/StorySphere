<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorySphere</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6036065566084740" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        html { scroll-behavior: smooth; } 
        body { overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        .glassmorphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; overflow-y: auto; }
        .modal-content { max-width: 800px; margin: 2rem auto; } 
        #age-gate-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; justify-content: center; align-items: center; }
        .swiper-slide { background-size: cover; background-position: center; }
        .rating-stars span { cursor: pointer; color: #4b5563; font-size: 2rem; transition: color 0.2s; }
        .rating-stars span.selected, .rating-stars span:hover, .rating-stars span:hover ~ span { color: #f59e0b; }
        #review-toggle-button .arrow-icon { transition: transform 0.3s; }
        #review-toggle-button.open .arrow-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white">
    <div id="canvas-container"></div>
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="glassmorphism p-4 flex justify-between items-center relative">
            <h1 class="text-3xl font-bold tracking-tight">StorySphere</h1>
            <nav class="hidden md:flex space-x-6">
                <a href="#browse" class="text-lg hover:text-pink-300">Browse</a>
                <a href="#private-browse" id="private-link-desktop" class="text-lg hover:text-pink-300">Private Novels</a>
                <a href="#about" class="text-lg hover:text-pink-300">About</a>
            </nav>
            <div class="md:hidden">
                <button id="menu-btn" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
            <div id="mobile-menu" class="hidden md:hidden absolute top-full right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg z-30">
                <a href="#browse" class="menu-item block px-4 py-2 text-sm text-white hover:bg-gray-700">Browse</a>
                <a href="#private-browse" id="private-link-mobile" class="menu-item block px-4 py-2 text-sm text-white hover:bg-gray-700">Private Novels</a>
                <a href="#about" class="menu-item block px-4 py-2 text-sm text-white hover:bg-gray-700">About</a>
            </div>
        </header>
        
        <div id="featured-slider" class="swiper h-64 md:h-96 w-full">
            <div class="swiper-wrapper"></div>
            <div class="swiper-pagination"></div>
        </div>

        <main class="flex-grow flex flex-col items-center py-12 px-4">
            <section id="upcoming" class="w-full max-w-6xl mb-16">
                <h2 class="text-3xl font-bold text-center mb-6 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-amber-600">Coming Soon</h2>
                <div id="upcoming-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            </section>
            <section id="browse" class="w-full max-w-6xl mb-12">
                <h2 class="text-3xl font-bold text-center mb-6">Public Novels</h2>
                <div id="browse-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
            <section id="private-browse" class="w-full max-w-6xl" style="display: none;">
                <h2 class="text-3xl font-bold text-center mb-6">Private Novels (18+)</h2>
                <div id="private-browse-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
        </main>

        <section id="about" class="py-12 px-4">
            <div class="max-w-4xl mx-auto glassmorphism p-8 rounded-xl">
                <h2 class="text-3xl font-bold text-center mb-4">About StorySphere</h2>
                <p class="text-center text-gray-200 mb-4">StorySphere is a magical place where stories come to life. We believe in the power of imagination and offer an immersive reading experience that blends technology with the timeless art of storytelling. Dive in and explore new worlds!</p>
                <p class="text-center text-gray-400 text-sm">This website is developed by Salman Khan Orakzai.</p>
            </div>
        </section>
        
        <div id="age-gate-popup" class="flex">
            <div class="glassmorphism p-8 rounded-xl text-center w-11/12 max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300">Content Warning</h2>
                <p class="text-lg mb-6">This section contains mature content. Are you 18 or older?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmAgeBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Yes, I am 18+</button>
                    <button id="denyAgeBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded">No, Go Back</button>
                </div>
            </div>
        </div>
        
        <div id="offer-popup" class="modal">
            <div class="modal-content glassmorphism p-8 rounded-xl text-center">
                <h3 class="text-2xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-yellow-500">âœ¨ Exclusive Offer! âœ¨</h3>
                <p class="text-lg text-gray-200 mb-6">Visit our partner store for amazing discounts!</p>
                <div class="flex justify-center gap-4">
                    <a href="https://noore-elegance-store.vercel.app/" target="_blank" class="bg-pink-500 text-white px-6 py-3 rounded-lg hover:bg-pink-600">ðŸ›’ Shop Now</a>
                    <button id="continue-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Continue to Story</button>
                </div>
            </div>
        </div>
        
        <div id="book-modal" class="modal">
            <div class="modal-content p-6 rounded-xl glassmorphism">
                <div class="flex flex-col md:flex-row gap-6">
                    <img id="book-image" class="w-full md:w-1/3 rounded-lg">
                    <div class="flex-1">
                        <h2 id="book-title" class="text-3xl font-bold mb-2"></h2>
                        <p id="book-author" class="text-gray-300 mb-2 text-lg"></p>
                        <p id="book-genre" class="text-gray-300 mb-2"></p>
                        <p id="book-pages" class="text-gray-300 mb-4"></p>
                        <p id="book-description" class="text-gray-200 mb-6"></p>
                        <div id="series-info" class="mb-6"></div>
                        <div class="flex flex-wrap gap-4 mb-6">
                            <a id="read-btn" href="#" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600">Read Now</a>
                            <a id="download-btn" href="#" download class="bg-yellow-500 text-black px-4 py-2 rounded-lg hover:bg-yellow-600">Download</a>
                            <button id="share-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Share</button>
                            <button id="close-modal" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Close</button>
                        </div>
                        <hr class="border-gray-600 my-4">
                        <div class="space-y-4">
                            <button id="review-toggle-button" class="w-full flex justify-between items-center text-left text-xl font-semibold">
                                <span>Reviews</span>
                                <i class="fas fa-chevron-down arrow-icon"></i>
                            </button>
                            <div id="review-content" class="hidden pl-2 border-l-2 border-gray-600">
                                <h3 class="text-lg font-semibold mt-4">Leave a Review</h3>
                                <form id="rating-form" class="space-y-3 mt-2">
                                    <div class="rating-stars" data-rating="0">
                                        <span data-value="1">â˜…</span><span data-value="2">â˜…</span><span data-value="3">â˜…</span><span data-value="4">â˜…</span><span data-value="5">â˜…</span>
                                    </div>
                                    <input type="text" id="reviewer-name" placeholder="Your Name" class="w-full p-2 rounded-lg text-black" required>
                                    <textarea id="review-text" placeholder="Write your review..." class="w-full p-2 rounded-lg text-black" rows="3" required></textarea>
                                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg w-full">Submit Review</button>
                                </form>
                                <h3 class="text-lg font-semibold mt-6">All Reviews</h3>
                                <div id="reviews-list" class="space-y-4 max-h-48 overflow-y-auto mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="glassmorphism p-6 text-center text-gray-300">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="https://www.tiktok.com/@hba013?_t=ZS-8yy2XEeMu7l&_r=1" target="_blank" class="social-icon text-2xl hover:text-pink-300"><i class="fab fa-tiktok"></i></a>
                <a href="https://www.instagram.com/salman_orakxi?igsh=dWlxc2oxZnlyd3Bo" target="_blank" class="social-icon text-2xl hover:text-pink-300"><i class="fab fa-instagram"></i></a>
                <a href="https://wa.me/03275176283" target="_blank" class="social-icon text-2xl hover:text-pink-300"><i class="fab fa-whatsapp"></i></a>
            </div>
            <p>&copy; 2025 StorySphere. All rights reserved.</p>
        </footer>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://zovzpiolbqezdjghhrgt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvdnpwaW9sYnFlemRqZ2hocmd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4Nzc0NzMsImV4cCI6MjA3MTA1MzQ3M30.t_dvIsnbwUFsgB1Bs1gcyo_Mic-z3i0g6pqMeQIoiXI';
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let books = [], series = [], upcoming = [], selectedBookId = null;

        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const ageGatePopup = document.getElementById('age-gate-popup');
        const privateBrowseSection = document.getElementById('private-browse');
        const reviewToggleButton = document.getElementById('review-toggle-button');
        const reviewContent = document.getElementById('review-content');
        const ratingForm = document.getElementById('rating-form');
        const ratingStars = document.querySelector('.rating-stars');
        let currentRating = 0;

        menuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        document.querySelectorAll('.menu-item').forEach(item => { item.addEventListener('click', () => mobileMenu.classList.add('hidden')); });
        const handlePrivateLinkClick = e => { e.preventDefault(); if (localStorage.getItem('ageConfirmed') === 'true') { privateBrowseSection.style.display = 'block'; window.location.hash = '#private-browse'; } else { ageGatePopup.style.display = 'flex'; } mobileMenu.classList.add('hidden'); };
        document.getElementById('private-link-desktop').addEventListener('click', handlePrivateLinkClick);
        document.getElementById('private-link-mobile').addEventListener('click', handlePrivateLinkClick);
        document.getElementById('confirmAgeBtn').addEventListener('click', () => { localStorage.setItem('ageConfirmed', 'true'); ageGatePopup.style.display = 'none'; privateBrowseSection.style.display = 'block'; window.location.hash = '#private-browse'; });
        document.getElementById('denyAgeBtn').addEventListener('click', () => { ageGatePopup.style.display = 'none'; });
        document.getElementById('continue-btn').addEventListener('click', () => { document.getElementById('offer-popup').style.display = 'none'; showBookDetails(selectedBookId); });
        document.getElementById('close-modal').addEventListener('click', () => { document.getElementById('book-modal').style.display = 'none'; });
        reviewToggleButton.addEventListener('click', () => { reviewContent.classList.toggle('hidden'); reviewToggleButton.classList.toggle('open'); });
        ratingStars.addEventListener('click', e => { if(e.target.tagName === 'SPAN') { currentRating = e.target.dataset.value; Array.from(ratingStars.children).forEach(star => { star.classList.toggle('selected', star.dataset.value <= currentRating); }); } });
        
        ratingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentRating === 0) { alert('Please select a star rating.'); return; }
            const newRating = { book_id: selectedBookId, rating: currentRating, reviewer_name: document.getElementById('reviewer-name').value, review_text: document.getElementById('review-text').value };
            const { error } = await supabase.from('ratings').insert([newRating]);
            if (error) { alert(error.message); }
            else { alert('Thank you for your review!'); ratingForm.reset(); currentRating=0; Array.from(ratingStars.children).forEach(s => s.classList.remove('selected')); loadReviews(selectedBookId); }
        });

        async function getData() {
            let { data: bookData } = await supabase.from('books').select('*').order('created_at', { ascending: false });
            let { data: seriesData } = await supabase.from('series').select('*');
            let { data: upcomingData } = await supabase.from('upcoming_novels').select('*').order('created_at', { ascending: false });
            books = bookData || []; series = seriesData || []; upcoming = upcomingData || [];
            renderBookCards(); renderUpcomingCards(); setupSlider();
        }

        function setupSlider() {
            const sliderWrapper = document.querySelector('#featured-slider .swiper-wrapper');
            sliderWrapper.innerHTML = '';
            books.slice(0, 4).forEach(book => {
                const slide = document.createElement('div');
                slide.className = 'swiper-slide';
                slide.style.backgroundImage = `url(${book.image})`;
                slide.innerHTML = `<div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col justify-center items-center text-center p-4"><h2 class="text-2xl md:text-4xl font-bold">${book.title}</h2><p class="text-lg my-2">${book.author}</p><button class="mt-4 bg-pink-500 text-white px-4 py-2 rounded-lg" onclick="showBookDetailsWrapper(${book.id})">View Details</button></div>`;
                sliderWrapper.appendChild(slide);
            });
            new Swiper('#featured-slider', { loop: true, autoplay: { delay: 4000, disableOnInteraction: false }, pagination: { el: '.swiper-pagination', clickable: true }, });
        }

        function renderUpcomingCards() {
            const upcomingGrid = document.getElementById('upcoming-grid');
            upcomingGrid.innerHTML = '';
            upcoming.forEach(item => {
                const card = document.createElement('div');
                card.className = 'glassmorphism p-4 rounded-xl text-center';
                card.innerHTML = `<img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover rounded-lg mb-2"><h4 class="font-bold">${item.title}</h4><p class="text-sm text-gray-300">${item.author}</p><p class="text-xs text-amber-400 mt-1">${item.release_date}</p>`;
                upcomingGrid.appendChild(card);
            });
        }

        function renderBookCards() {
            const publicGrid = document.getElementById('browse-grid');
            const privateGrid = document.getElementById('private-browse-grid');
            publicGrid.innerHTML = ''; privateGrid.innerHTML = '';
            books.forEach(book => {
                const container = book.is_private ? privateGrid : publicGrid;
                createCard(book, container);
            });
            addCardEventListeners();
        }

        function createCard(bookData, container) {
            const card = document.createElement('div');
            card.className = 'glassmorphism p-6 rounded-xl hover-scale book-card';
            card.setAttribute('data-book-id', bookData.id);
            const seriesInfo = bookData.series_id ? series.find(s => s.id === bookData.series_id) : null;
            const seriesName = seriesInfo ? `<p class="text-xs text-pink-400 mb-2">${seriesInfo.title}</p>` : '';
            card.innerHTML = `<h3 class="text-xl font-semibold mb-2">${bookData.title}</h3>${seriesName}<p class="text-gray-300 mb-4">${bookData.author || ''}</p><button class="bg-pink-500 text-white px-4 py-2 rounded-lg w-full">View Details</button>`;
            container.appendChild(card);
        }

        function addCardEventListeners(){ document.querySelectorAll(".book-card button").forEach(button => { button.addEventListener("click", () => { const card = button.closest('.book-card'); const bookId = parseInt(card.getAttribute('data-book-id')); showBookDetailsWrapper(bookId); }); }); }
        
        function showBookDetailsWrapper(bookId) { const bookData = books.find(b => b.id === bookId); if (bookData && bookData.is_private && localStorage.getItem('ageConfirmed') !== 'true') { selectedBookId = bookId; ageGatePopup.style.display = 'flex'; } else { showBookDetails(bookId); } }
        
        function showBookDetails(bookId) {
            selectedBookId = bookId;
            const bookData = books.find(b => b.id === bookId);
            if (!bookData) return;
            
            document.getElementById('book-image').src = bookData.image;
            document.getElementById('book-title').textContent = bookData.title;
            document.getElementById('book-author').textContent = `By ${bookData.author || 'Unknown Author'}`;
            document.getElementById('book-genre').textContent = `Genre: ${bookData.genre}`;
            document.getElementById('book-pages').textContent = `Length: ${bookData.pages}`;
            document.getElementById('book-description').textContent = bookData.description;
            
            const readBtn = document.getElementById('read-btn');
            const downloadBtn = document.getElementById('download-btn');
            const shareBtn = document.getElementById('share-btn');
            
            const seriesInfoContainer = document.getElementById('series-info');
            seriesInfoContainer.innerHTML = '';
            if (bookData.series_id) {
                const seriesInfo = series.find(s => s.id === bookData.series_id);
                const seriesBooks = books.filter(b => b.series_id === bookData.series_id).sort((a, b) => a.title.localeCompare(b.title));
                let seriesHTML = `<h4 class="text-lg font-semibold text-pink-400 mb-2">Part of "${seriesInfo.title}" Series</h4><ul class="list-disc list-inside text-gray-300">`;
                seriesBooks.forEach(part => { seriesHTML += `<li>${part.title} ${part.id === bookData.id ? '<span class="text-yellow-300">(You are here)</span>' : ''}</li>`; });
                seriesHTML += `</ul>`;
                seriesInfoContainer.innerHTML = seriesHTML;
            }
            
            if (bookData.story_text) { readBtn.href = `reader.html?id=${bookData.id}`; readBtn.removeAttribute('target'); readBtn.style.display = 'inline-block'; } else { readBtn.style.display = 'none'; }
            if (bookData.pdf) { downloadBtn.href = bookData.pdf; downloadBtn.style.display = 'inline-block'; } else { downloadBtn.style.display = 'none'; }
            shareBtn.onclick = async () => { try { await navigator.share({ title: bookData.title, text: `Check out "${bookData.title}" on StorySphere!`, url: window.location.href }); } catch (err) { alert('Sharing failed.'); } };
            
            loadReviews(bookId);
            reviewContent.classList.add('hidden');
            reviewToggleButton.classList.remove('open');
            document.getElementById('book-modal').style.display = 'block';
        }

        async function loadReviews(bookId) {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = 'Loading...';
            const { data, error } = await supabase.from('ratings').select('*').eq('book_id', bookId).order('created_at', { ascending: false });
            if (error) { reviewsList.innerHTML = 'Could not load reviews.'; }
            else {
                reviewsList.innerHTML = '';
                if (data.length === 0) { reviewsList.innerHTML = '<p>No reviews yet.</p>'; }
                data.forEach(review => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'bg-gray-700 p-3 rounded';
                    reviewDiv.innerHTML = `<p class="font-bold">${review.reviewer_name} - ${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5-review.rating)}</p><p>${review.review_text}</p>`;
                    reviewsList.appendChild(reviewDiv);
                });
            }
        }
        
        getData();
        
        const scene=new THREE.Scene(),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({alpha:!0});renderer.setSize(window.innerWidth,window.innerHeight),document.getElementById("canvas-container").appendChild(renderer.domElement);const bookGeometry=new THREE.BoxGeometry(2,3,.3),bookTexture=(new THREE.TextureLoader).load("https://images.unsplash.com/photo-1544716278-ca5e3f4ebf0c?auto=format&fit=crop&w=200"),bookMaterial=new THREE.MeshStandardMaterial({map:bookTexture,roughness:.4,metalness:.2}),book=new THREE.Mesh(bookGeometry,bookMaterial);scene.add(book);const ambientLight=new THREE.AmbientLight(16777215,.6);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(16777215,.8);directionalLight.position.set(5,5,5),scene.add(directionalLight),camera.position.z=5;function animate(){requestAnimationFrame(animate);book.rotation.y+=.005;book.position.y=Math.sin(.001*Date.now())*.2;renderer.render(scene,camera)}animate(),window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)});
    </script>
</body>
</html>