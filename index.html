<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorySphere</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6036065566084740" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        html { scroll-behavior: smooth; } 
        body { overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        .glassmorphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; overflow-y: auto; }
        .modal-content { max-width: 800px; margin: 2rem auto; } 
        #age-gate-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; justify-content: center; align-items: center; }
        .swiper-slide { background-size: cover; background-position: center; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white">
    <div id="canvas-container"></div>
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="glassmorphism p-4 flex justify-between items-center relative">
            <h1 class="text-3xl font-bold tracking-tight">StorySphere</h1>
            <nav class="hidden md:flex space-x-6"><a href="#browse">Browse</a><a href="#private-browse" id="private-link-desktop">Private Novels</a><a href="#about">About</a></nav>
            <div class="md:hidden"><button id="menu-btn"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div>
            <div id="mobile-menu" class="hidden md:hidden absolute top-full right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg z-30"><a href="#browse" class="menu-item">Browse</a><a href="#private-browse" id="private-link-mobile" class="menu-item">Private Novels</a><a href="#about" class="menu-item">About</a></div>
        </header>
        
        <div id="featured-slider" class="swiper h-64 md:h-96 w-full"><div class="swiper-wrapper"></div><div class="swiper-pagination"></div></div>

        <main class="flex-grow flex flex-col items-center py-12 px-4">
            <section id="upcoming" class="w-full max-w-6xl mb-16">
                <h2 class="text-3xl font-bold text-center mb-6 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-amber-600">Coming Soon</h2>
                <div id="upcoming-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            </section>
            <section id="browse" class="w-full max-w-6xl mb-12"><h2 class="text-3xl font-bold text-center mb-6">Public Novels</h2><div id="browse-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>
            <section id="private-browse" class="w-full max-w-6xl" style="display: none;"><h2 class="text-3xl font-bold text-center mb-6">Private Novels (18+)</h2><div id="private-browse-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>
        </main>

        <section id="about" class="py-12 px-4"><div class="max-w-4xl mx-auto glassmorphism p-8 rounded-xl"><h2 class="text-3xl font-bold text-center mb-4">About StorySphere</h2><p class="text-center text-gray-200 mb-4">...</p><p class="text-center text-gray-400 text-sm">Developed by Salman Khan Orakzai.</p></div></section>
        <div id="age-gate-popup" class="flex"><!-- Age gate --></div>
        <div id="offer-popup" class="modal"><!-- Offer popup --></div>
        <div id="book-modal" class="modal"><!-- Book details modal --></div>
        <footer class="glassmorphism p-6 text-center text-gray-300"><!-- Footer --></footer>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://zovzpiolbqezdjghhrgt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvdnpwaW9sYnFlemRqZ2hocmd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4Nzc0NzMsImV4cCI6MjA3MTA1MzQ3M30.t_dvIsnbwUFsgB1Bs1gcyo_Mic-z3i0g6pqMeQIoiXI';
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let books = [], series = [], upcoming = [], selectedBookId = null;

        async function getData() {
            let { data: bookData } = await supabase.from('books').select('*').order('created_at', { ascending: false });
            let { data: seriesData } = await supabase.from('series').select('*');
            let { data: upcomingData } = await supabase.from('upcoming_novels').select('*').order('created_at', { ascending: false });
            books = bookData || []; series = seriesData || []; upcoming = upcomingData || [];
            renderBookCards(); renderUpcomingCards(); setupSlider();
        }

        function renderUpcomingCards() {
            const upcomingGrid = document.getElementById('upcoming-grid');
            upcomingGrid.innerHTML = '';
            upcoming.forEach(item => {
                const card = document.createElement('div');
                card.className = 'glassmorphism p-4 rounded-xl text-center';
                card.innerHTML = `<img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover rounded-lg mb-2"><h4 class="font-bold">${item.title}</h4><p class="text-sm text-gray-300">${item.author}</p><p class="text-xs text-amber-400 mt-1">${item.release_date}</p>`;
                upcomingGrid.appendChild(card);
            });
        }

        // Baaki saara JavaScript pehle jaisa (mukammal)
        const menuBtn=document.getElementById("menu-btn"),mobileMenu=document.getElementById("mobile-menu"),ageGatePopup=document.getElementById("age-gate-popup"),privateBrowseSection=document.getElementById("private-browse");menuBtn.addEventListener("click",()=>mobileMenu.classList.toggle("hidden")),document.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",()=>mobileMenu.classList.add("hidden"))});const handlePrivateLinkClick=e=>{e.preventDefault(),"true"===localStorage.getItem("ageConfirmed")?(privateBrowseSection.style.display="block",window.location.hash="#private-browse"):ageGatePopup.style.display="flex",mobileMenu.classList.add("hidden")};document.getElementById("private-link-desktop").addEventListener("click",handlePrivateLinkClick),document.getElementById("private-link-mobile").addEventListener("click",handlePrivateLinkClick),document.getElementById("confirmAgeBtn").addEventListener("click",()=>{localStorage.setItem("ageConfirmed","true"),ageGatePopup.style.display="none",privateBrowseSection.style.display="block",window.location.hash="#private-browse"}),document.getElementById("denyAgeBtn").addEventListener("click",()=>{ageGatePopup.style.display="none"}),document.getElementById("continue-btn").addEventListener("click",()=>{document.getElementById("offer-popup").style.display="none",showBookDetails(selectedBookId)}),document.getElementById("close-modal").addEventListener("click",()=>{document.getElementById("book-modal").style.display="none"}),reviewToggleButton.addEventListener("click",()=>{reviewContent.classList.toggle("hidden"),reviewToggleButton.classList.toggle("open")});function setupSlider(){const e=document.querySelector("#featured-slider .swiper-wrapper");e.innerHTML="",books.slice(0,4).forEach(t=>{const s=document.createElement("div");s.className="swiper-slide",s.style.backgroundImage=`url(${t.image})`,s.innerHTML=`<div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col justify-center items-center text-center p-4"><h2 class="text-2xl md:text-4xl font-bold">${t.title}</h2><p class="text-lg my-2">${t.author}</p><button class="mt-4 bg-pink-500 text-white px-4 py-2 rounded-lg" onclick="showBookDetailsWrapper(${t.id})">View Details</button></div>`,e.appendChild(s)}),new Swiper("#featured-slider",{loop:!0,autoplay:{delay:4e3,disableOnInteraction:!1},pagination:{el:".swiper-pagination",clickable:!0}})}function renderBookCards(){const e=document.getElementById("browse-grid"),t=document.getElementById("private-browse-grid");e.innerHTML="",t.innerHTML="",books.forEach(s=>{const o=s.is_private?t:e;createCard(s,o)}),addCardEventListeners()}function createCard(e,t){const s=document.createElement("div");s.className="glassmorphism p-6 rounded-xl hover-scale book-card",s.setAttribute("data-book-id",e.id);const o=e.series_id?series.find(t=>t.id===e.series_id):null,n=o?`<p class="text-xs text-pink-400 mb-2">${o.title}</p>`:"";s.innerHTML=`<h3 class="text-xl font-semibold mb-2">${e.title}</h3>${n}<p class="text-gray-300 mb-4">${e.author||""}</p><button class="bg-pink-500 text-white px-4 py-2 rounded-lg w-full">View Details</button>`,t.appendChild(s)}function addCardEventListeners(){document.querySelectorAll(".book-card button").forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".book-card"),s=parseInt(t.getAttribute("data-book-id"));showBookDetailsWrapper(s)})})}function showBookDetailsWrapper(e){const t=books.find(t=>t.id===e);t&&t.is_private&&"true"!==localStorage.getItem("ageConfirmed")?(selectedBookId=e,document.getElementById("age-gate-popup").style.display="flex"):showBookDetails(e)}function showBookDetails(e){selectedBookId=e;const t=books.find(t=>t.id===e);if(t){document.getElementById("book-image").src=t.image,document.getElementById("book-title").textContent=t.title,document.getElementById("book-author").textContent=`By ${t.author||"Unknown Author"}`,document.getElementById("book-genre").textContent=`Genre: ${t.genre}`,document.getElementById("book-pages").textContent=`Length: ${t.pages}`,document.getElementById("book-description").textContent=t.description;const e=document.getElementById("read-btn"),s=document.getElementById("download-btn"),o=document.getElementById("share-btn"),n=document.getElementById("series-info");if(n.innerHTML="",t.series_id){const e=series.find(e=>e.id===t.series_id),s=books.filter(e=>e.series_id===t.series_id).sort((e,t)=>e.title.localeCompare(t.title));let o=`<h4 class="text-lg font-semibold text-pink-400 mb-2">Part of "${e.title}" Series</h4><ul class="list-disc list-inside text-gray-300">`;s.forEach(e=>{o+=`<li>${e.title} ${e.id===t.id?'<span class="text-yellow-300">(You are here)</span>':""}</li>`}),o+="</ul>",n.innerHTML=o}t.story_text?(e.href=`reader.html?id=${t.id}`,e.removeAttribute("target"),e.style.display="inline-block"):e.style.display="none",t.pdf?(s.href=t.pdf,s.style.display="inline-block"):s.style.display="none",o.onclick=async()=>{try{await navigator.share({title:t.title,text:`Check out "${t.title}" on StorySphere!`,url:window.location.href})}catch(e){alert("Sharing failed.")}},loadReviews(bookId),reviewContent.classList.add("hidden"),reviewToggleButton.classList.remove("open"),document.getElementById("book-modal").style.display="block"}}const ratingForm=document.getElementById("rating-form"),ratingStars=document.querySelector(".rating-stars");let currentRating=0;ratingStars.addEventListener("click",e=>{if("SPAN"===e.target.tagName){currentRating=e.target.dataset.value;for(const t of ratingStars.children)t.classList.toggle("selected",t.dataset.value<=currentRating)}}),ratingForm.addEventListener("submit",async e=>{e.preventDefault();if(0===currentRating)return void alert("Please select a star rating.");const t={book_id:selectedBookId,rating:currentRating,reviewer_name:document.getElementById("reviewer-name").value,review_text:document.getElementById("review-text").value};const{error}=await supabase.from("ratings").insert([t]);error?alert(error.message):(alert("Thank you for your review!"),ratingForm.reset(),currentRating=0,Array.from(ratingStars.children).forEach(e=>e.classList.remove("selected")),loadReviews(selectedBookId))});async function loadReviews(e){const t=document.getElementById("reviews-list");t.innerHTML="Loading...";const{data,error}=await supabase.from("ratings").select("*").eq("book_id",e).order("created_at",{ascending:!1});if(error)t.innerHTML="Could not load reviews.";else if(t.innerHTML="",0===data.length)t.innerHTML="<p>No reviews yet.</p>";else for(const e of data){const s=document.createElement("div");s.className="bg-gray-700 p-3 rounded",s.innerHTML=`<p class="font-bold">${e.reviewer_name} - ${"★".repeat(e.rating)}${"☆".repeat(5-e.rating)}</p><p>${e.review_text}</p>`,t.appendChild(s)}};
        getData();
        const scene=new THREE.Scene(),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({alpha:!0});renderer.setSize(window.innerWidth,window.innerHeight),document.getElementById("canvas-container").appendChild(renderer.domElement);const bookGeometry=new THREE.BoxGeometry(2,3,.3),bookTexture=(new THREE.TextureLoader).load("https://images.unsplash.com/photo-1544716278-ca5e3f4ebf0c?auto=format&fit=crop&w=200"),bookMaterial=new THREE.MeshStandardMaterial({map:bookTexture,roughness:.4,metalness:.2}),book=new THREE.Mesh(bookGeometry,bookMaterial);scene.add(book);const ambientLight=new THREE.AmbientLight(16777215,.6);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(16777215,.8);directionalLight.position.set(5,5,5),scene.add(directionalLight),camera.position.z=5;function animate(){requestAnimationFrame(animate);book.rotation.y+=.005;book.position.y=Math.sin(.001*Date.now())*.2;renderer.render(scene,camera)}animate(),window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)});
    </script>
</body>
</html>